## 实时 BPM 估计设计

### 目标
- BPM 范围：60–200
- 实时更新：每 200–500 ms 刷新一次估计值
- 稳定输出：避免频繁跳变，提供置信度

### 预处理
- 统一为 `f32/48k/mono`
- 带通滤波：约 40–2000 Hz（抑制直流与超高频噪声）
- 能量归一化：短时均方根（RMS）或峰值限制，避免电平波动

### 特征提取（两案并行对比）
- **能量包络法**（低复杂度，实时友好）
  - 整流 → 低通平滑（移动平均/一阶 IIR）→ 峰值间距统计
  - 对节拍弱的音乐可能不稳定
- **谱差/谱流（Spectral Flux）**（鲁棒性更好）
  - 窗口 FFT（Hann，N=2048，hop=512）→ 与上帧谱差的正半波 → 平滑
  - 在鼓点与瞬态明显音乐中效果更佳

### 候选 BPM 生成
- 对包络/谱流做自相关，寻找主峰位置 `lag*`
- 将 `lag` 映射为 BPM：`bpm = 60 * fs / (lag * hop)`（或按包络采样率计算）
- 倍频/半频消歧：比较 `0.5x/1x/2x` 邻域能量，结合节拍先验（常见 80–160）

### 稳定与置信度
- 估计历史的指数平滑（EMA）与滞回（hysteresis）
- 置信度 = 主峰与次峰能量差 / 总能量，或基于峰尖锐度
- 低置信度时减缓输出更新节奏

### 实时策略
- 滑动窗口 8–12 s，步长 0.5 s（可配置）
- 初期收敛：前 2–4 s 内以更低权重输出或标注“分析中”

### 依赖建议
- `rustfft` 或 `realfft`：FFT 实现
- `microfft`：可选的更小型 FFT

### API 草案
```rust
struct BpmEstimate { bpm: f32, confidence: f32 }
impl BpmEstimator {
    fn new(config: BpmConfig) -> Self { /* ... */ }
    fn push_frames(&mut self, frames: &[f32]) -> Option<BpmEstimate> { /* ... */ }
}
```

### 指标验证
- 合成节拍（点击音）基准测试：60/90/120/150/180 BPM
- 流媒体歌曲集：流行/摇滚/电子/嘻哈/古典多样性
- 测试记录：均方误差、稳定时间、抖动幅度
