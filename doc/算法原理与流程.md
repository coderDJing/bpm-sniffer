## 概述

本说明文档以中文、无代码的形式，系统阐述 BPM Sniffer 当前“节拍（BPM）测量”算法的原理与完整流程，覆盖从音频采集、预处理、特征构建、节拍周期估计、结果融合与后处理、到展示与稳定性的各个环节。

### 目标与边界

- **目标**：从系统正在播放的音频（无需安装额外驱动/虚拟声卡）中，快速、稳定地估计曲目的 BPM，并在切歌、弱节奏、谐波歧义等场景下保持较好的鲁棒性和跟随性。
- **适用范围**：当前算法针对电子与流行音乐中较常见的节奏范围做了优化，默认输出范围集中在 91–180 BPM（内部会做 0.5×/2× 折算归一）。
- **平台说明**：在 Windows 使用系统回环（WASAPI Loopback）采集系统混音；无需终端用户安装额外软件或驱动。

## 处理链路总览

整体采用“流式”架构，以固定步长在滑动窗口上持续估计：

1. 系统回环采集音频帧（单声道化、浮点化）。
2. 鼓点增强与包络构建（高通→低通→正向差分）。
3. 下采样至较低速率（约 200 Hz），并做温和平滑，形成“节拍能量包络”。
4. 维护约 4 秒长度的包络缓冲，按需截取“长窗”和“自适应短窗”。
5. 在候选窗口上进行自相关打分，并结合多重先验与质量门限筛选出节拍周期。
6. 对最优延迟做亚采样细化（抛物线插值），并与鼓点间隔中值二次确认。
7. 将短窗与长窗估计按条件融合，输出“原始 BPM + 置信度 + 窗口信息”。
8. 展示层进行稳态判定、锚点纠偏、谐波/倍频归一、整数锁、软门/硬门与平滑预测，最终产出用于 UI 的稳定 BPM。
9. 全程伴随可视化下采样、无声/弱信号 gating、采样率/设备切换自恢复等稳健性措施。

## 音频采集与预处理

### 系统回环采集（Windows）

- 使用系统混音格式进行回环捕获（共享模式 + 事件回调），自动适配当前默认输出设备与采样率变化。
- 每次数据包到来，将多声道混合为单声道，并统一为浮点振幅，维持一个“帧队列”。
- 设备切换、蓝牙断连等异常会触发自动重建，外部无需干预。

### 鼓点增强与包络构建

- 对原始音频施加“一阶高通（约 40Hz）→ 一阶低通（约 180Hz）”，突出鼓点能量带。
- 使用“正向差分（仅取正增量）”强调瞬态攻击，以提升鼓点对齐的一致性。
- 在下采样累积前，进行分段平均并叠加温和 IIR 平滑，抑制抖动。

### 下采样与缓冲

- 将包络下采样至约 200 Hz，显著降低自相关计算成本。
- 维护一个长度约 4 秒的环形缓冲，随时间滚动；同时记录下采样包络的能量（RMS）并进行静音门限。

## 候选窗口：长窗与自适应短窗

- **长窗**：直接对当前缓冲（约 ≤4s）做评估，兼顾稳态场景下的稳定性。
- **短窗（自适应）**：基于上一次输出 BPM 推断单周期时长，目标包含 2–3 个节拍，限制在 2–4 秒内，使其在切歌与过渡段更灵敏。
- 两者均需通过质量门限（见下）方可成为有效候选。

## 质量门限与预筛选

为避免弱节奏或非节拍结构导致的误检，算法在进入自相关前后设置多重门限：

- **能量门限**：包络 RMS 过低直接跳过（静音/极弱信号）。
- **首尾裁剪**：以峰值 3% 为阈值裁剪窗口两端静默，保留“有效区间”。
- **最短长度**：窗口需覆盖至少约 1.6 秒的有效数据。
- **峰检测与显著性**：
  - 动态阈值（结合全局比例阈值与分位点阈值）。
  - 最小峰间距由最大 BPM 推导，避免过密虚假峰。
  - 峰“突出度”检验（峰值相对左右邻域的高度差）。
- **峰数量与密度**：峰数量应与窗口时长匹配；峰密度需处于合理范围（避免噪声/鼓点稀疏段）。
- **节拍规律性**：用峰间隔的变异系数（CV）评估稳定度，过高则剔除。
- **峰态（Peakiness）**：以 |x| 的 p95/p50 比例衡量“尖锐程度”，太平则拒绝。

若通过以上筛选，再进入“对齐裁剪”：按峰位置仅保留从第一峰到最后一峰的范围，两侧按中位峰间隔留一定缓冲，提升自相关对齐度；若裁剪后过短则回退用未裁剪片段。

## 自相关打分与先验融合

在允许的延迟范围内（由 BPM 搜索范围换算得到）计算归一化自相关系数 r，并融合两个温和先验形成最终得分：

- **全局先验**：以 120 BPM 为中心的高斯权重（σ≈50），对常见舞曲节奏给予温和偏好。
- **栅格先验**：对“整数 BPM”进行高斯吸附（不偏好半整数），抑制 130.5 等半格漂移。

最终分数 = r ×（全局先验混合）×（栅格先验混合）。在全局延迟搜索中记录：最佳分数、次佳分数、以及所有分数的平均值。

### 置信度与可用性判定

- 要求：最佳分数足够高、与平均值的比例（“尖锐度”）足够大、与次优分数的差距（margin）不小。
- 增益：结合峰数量、稳定度（1−CV）对置信度做调制；若与 0.5×/2× 家族不一致，施加轻微惩罚。
- 低于最低置信门限（或边界延迟且分数偏低）则判为无效。

## 亚采样细化与二次确认

- **抛物线插值**：在最佳延迟附近取三点做二次曲线拟合，得到亚采样级的峰位置，从而细化 BPM。
- **IOI 中值确认**：若峰序列足够，计算相邻峰间隔的中值换算 BPM；与自相关 BPM 极为接近（相对误差 <≈0.8%）时做温和融合，降低量化与对齐噪声。

## 窗口融合与输出（算法层）

- 同时得到长窗与短窗候选：若两者差异明显（相对 >≈6%）、短窗置信度达到长窗的 75% 且短窗结果在时间上连续一致（至少两次），则短窗优先；否则采用长窗。
- 输出包含：BPM、置信度、来自短/长窗标记、窗口时长、以及供上层使用的能量指标。

## 展示与稳定化（应用层后处理）

应用层在 2 秒窗口、0.5 秒步长的滑动节奏上取用“算法层输出”，并叠加以下稳定化策略，仅影响“展示值”，不回写算法内部状态：

1. **状态机（tracking/uncertain/analyzing）**：
   - 使用两个阈值（高/低）计数进入或退出“追踪”状态，避免频繁抖动。
   - 连续多帧无有效估计或静音时，进入 analyzing 并显示 0。
2. **快速重锁（切歌与显著能量跳变）**：
   - 当能量 dB 在短时间内大幅变化，或展示值长距离偏离锁定整数、或长时间无有效估计后恢复时，进入短时“快速期”，放宽更新与切换条件以尽快跟上新歌。
3. **锚点纠偏与谐波归一**：
   - 维护一个随时间温和更新的“锚点 BPM”，优先选择更接近锚点的 0.5×、2×、2/3×、3/2× 等候选，以缓解谐波歧义。
   - 将候选折算到 91–180 BPM 的“标准 EDM 区间”，统一展示尺度。
4. **整数锁（带滞后与 TTL）**：
   - 高置信度且数值靠近某整数时吸附为整数显示；小幅偏离不立即解锁，显著偏离且稳定时再解锁。
   - 在快速期支持相邻整数的更快切换；长期未成功显示会自动清理锁定，防止卡死。
5. **稳态聚合与预测**：
   - 对最近约 1.5 秒的数值做中值聚合并以 EMA 平滑，抑制离群点。
   - 在低置信度时使用轻量 alpha–beta 预测器（位置与速度）提高过渡期的连贯性。
6. **软门/硬门与多数派强制**：
   - 硬门：高置信度且通过离群抑制时直接显示。
   - 软门：置信度略低但与近期候选一致时允许“灰显”展示，且若与前次高亮整数一致则继续高亮。
   - 多数派：若近期“候选整数”（而非已显示值）的众数在短时段内明显占优，也允许推动切换，避免被旧值粘住。
7. **可视化与能量**：
   - 以 ~30fps 节流向前端发送下采样波形与 RMS；极低电平时强制归零，避免残影。

## 鲁棒性与自恢复

- **静音/弱信号快速判定**：能量门限触发即清零与解锁，减少假阳性。
- **采样率变化**：监听系统混音采样率变化，自动重建后端并清空历史，避免旧状态污染新数据。
- **设备切换**：监视默认输出设备 ID 变化，自动重建回环链路，增强抗掉设备能力。
- **重置指令**：用户触发“重置”时，清空分析窗口、显示与内部状态，并立即通知前端清零。

## 关键参数（当前实现的代表值）

- **BPM 搜索范围**：min_bpm ≈ 91、max_bpm ≈ 180（展示层会做 0.5×/2× 折算归一）。
- **下采样速率**：ds_rate ≈ 200 Hz。
- **分析窗口**：
  - 长窗：缓冲上限约 4 秒（动态有效区）。
  - 短窗：2–4 秒，自适应目标覆盖 2–3 个节拍。
- **状态阈值（展示层）**：进入 tracking 的高阈值与退出的低阈值分离，避免抖动（基础约 0.40/0.25，超短窗放宽）。
- **静音判定**：可视化与分析层均设有能量门限（不同粒度）。

## 与用户体验相关的设计取舍

- **快速响应 vs 稳定显示**：通过“短窗优先 + 快速期 + 整数锁 + 软门/硬门 + 平滑预测”的组合，在切歌和过渡段提升跟随速度，同时在稳态段保持稳定展示。
- **谐波歧义处理**：锚点纠偏与 EDM 区间归一、加上栅格先验，降低 0.5×/2× 或 3/2×/2/3× 混淆带来的跳变。
- **无额外依赖**：采用系统回环能力，不需安装第三方虚拟声卡或插件。

## 流程图（文字版）

1) 采集系统回环音频 → 单声道、浮点化 → 鼓点增强（高通→低通→正向差分） → 下采样（≈200 Hz）→ IIR 平滑 → 写入 4s 环形缓冲。
2) 能量门限判定（静音则清零）→ 构造长窗与自适应短窗（剪裁与质检）。
3) 自相关延迟扫描（融合全局与栅格先验）→ 选取最优延迟与分数，判定可用性与置信度。
4) 抛物线插值细化 + IOI 中值二次确认 → 得到“算法层候选”。
5) 短/长窗融合（短窗在差异大且足够稳定时优先）。
6) 展示层：状态机 → 锚点纠偏与谐波归一 → 整数锁（滞后）→ 稳定聚合与预测 → 软门/硬门/多数派 → 输出显示 BPM。
7) 同步：~30fps 可视化波形与能量更新；采样率或设备变化时自动重建并清零。

## 注意事项与后续方向

- 某些极端编曲（复杂切分、明显律动变化、鼓点极弱）仍可能短时不稳定；建议结合更长时域特征或多通道节奏感知进一步增强。
- 对非 EDM/流行风格的更广 BPM 范围可通过参数调整与先验校准实现，但需重新评估快慢拍、谐波归一策略。


