# 调性（Key）实时估计：算法草案

## 概述

本文档以中文、无代码的形式，给出 BPM Sniffer 在现有“系统回环采集”能力之上，增加“实时调性（Key）估计”的一份可落地草案，用于后续实现与调参。

这里的“调性”指 **全局主调**（如 `C#m`、`F major`），输出随时间滚动更新，并给出置信度与“不确定”状态；**不覆盖和弦序列识别、调式（mode）分类、或精确的转调分段**（这些属于后续方向）。

当前处于实验阶段：**暂不增加前端展示位**，仅在后端控制台打印调性相关日志，便于快速迭代。

## 目标与边界

- **目标**：从当前播放音频中，滚动估计最近一段时间内的“最可能调性（12 大调 + 12 小调）”，实验阶段先以控制台输出为准，后续再接入 UI。
- **可接受延迟**：允许在 **≤15 秒**内达到稳定（随切歌/段落变化重新收敛）。
- **适用范围**：以流行/电子等“调性相对稳定、音高成分明显”的音乐为主；鼓点重、噪声大、极端和声/自由转调会降低置信度或输出“不确定”。
- **输入假设**：来自 Windows WASAPI Loopback 的系统混音；单声道化后为 `f32` 振幅序列；采样率可能变化。
- **输出约定**：
  - Key 名称：采用升号记名（`C, C#, D, ...`）与小写 `m` 表示小调（`C#m`）；大调可输出 `F` 或 `F major`，建议 UI 统一为短格式（`F` / `C#m`）。
  - 便于 DJ 观察的输出：可将 Key 映射为 **Camelot Wheel** 编号（`1A/1B...12A/12B`），实验日志阶段建议直接打印 Camelot。
  - 无调性：当音频片段缺少稳定谐波/旋律信息时，输出 `N/A(无调性)` 便于观察。
  - 置信度：`0..1`，并支持“不确定”（例如 `confidence < τ`）。

## 测试样本建议

- 真实曲目（House/French House，调性明确）：`Stardust - Music Sounds Better With You`（常见标注 `C#/Db Major`，Camelot `3B`；相对小调 `A#/Bb minor`，Camelot `3A`）。
- 合成样本（可重复、无版权风险）：运行 `python "scripts/generate_tonal_house_sample.py"` 生成固定调性的 House loop（默认 `C#/Db Major` / `3B`），用于回归与调参。

## 当前实现进度（实验后端已落地）

> 目标：你关闭当前对话后，新对话只看本文档即可继续开发与调参。

### 已落地代码（Rust / Tauri 后端）

- `src-tauri/src/key.rs`：`KeyEngine`（STFT + HPSS + chroma + 模板匹配 + 置信度 + `N/A(无调性)` gate）+ Camelot 映射。
- `src-tauri/src/capture.rs`：采集循环中调用 `KeyEngine::process(...)`，将 Key 转为 Camelot 后仅打印控制台日志（不占用前端展示位）。
- `src-tauri/src/logging.rs`：增加 `CONSOLE_LOG_LEVEL` 控制输出；当前默认 `1`（仅调性实验日志）。
- `src-tauri/Cargo.toml`：新增 `rustfft` 依赖用于 FFT。
- `scripts/generate_tonal_house_sample.py`：生成“调性非常明确”的 House WAV 样本（默认 `C#/Db Major` / Camelot `3B`），便于回归与调参。
- `.gitignore`：忽略 `tmp/`（用于生成样本 WAV，避免误提交）。

### 当前日志格式（仅控制台）

中文示例：

`[调性] 8A 置信度=0.42 分数=0.95 gap=0.00 次选=5A(0.95) 状态=uncertain 有效=12.2s 电平=0.44`

字段含义：

- `调性`：Camelot `1A..12B`；无调性段输出 `N/A(无调性)`。
- `分数`：Top-1 的模板匹配分数（当前为相关系数 + bass bonus）。
- `gap`：Top-1 与 Top-2 的差值。
- `置信度`：由 `分数` 与 `gap` 组合得到的 `0..1`。
- `状态`：`analyzing | atonal | uncertain | tracking`。
- `有效`：已积累的有效分析时长（秒）。
- `电平`：输入电平 `0..1`（来自 RMS→dB→归一化）。

打印节流：

- 引擎内部每 `update_interval_ms`（默认 `500ms`）产生一次估计。
- 控制台输出：`tracking` 至少间隔 `1500ms`；其他状态至少 `4000ms`；Key 变化时会提前输出。

日志开关：

- `src-tauri/src/logging.rs`：`CONSOLE_LOG_LEVEL=0/1/2`（0 静默，1 仅调性，2 全部文本日志）。

### Camelot 转换规则（已实现）

- `A` = 小调（minor），`B` = 大调（major），数字 `1..12` 为 Camelot Wheel 编号。
- 当前实现做 pitch class 映射：`C#` 与 `Db` 视为同一类（不做更细的异名同音区分）。
- 若未来需要支持 `Dbm/F#` 等多种记名，建议在“输出层”统一到内部 pitch class 后再映射 Camelot。

固定映射表（用于对照/排查，不建议在代码里重复维护两份）：

- Major：`C=8B, C#=3B, D=10B, D#=5B, E=12B, F=7B, F#=2B, G=9B, G#=4B, A=11B, A#=6B, B=1B`
- Minor：`Cm=5A, C#m=12A, Dm=7A, D#m=2A, Em=9A, Fm=4A, F#m=11A, Gm=6A, G#m=1A, Am=8A, A#m=3A, Bm=10A`

### “无调性 / 有旋律”区分（已实现：HPSS + tonal gate）

对话中确认过：很多片段（纯鼓点/噪声/FX）不具备稳定音高结构，强行输出 Key 会产生“看起来有数值但不可用”的误导；因此必须能输出 `N/A(无调性)`。

当前方案：

- 在 STFT 幅度谱上做 **HPSS**，仅用谐波谱 `S_h` 计算 chroma（降低打击乐干扰）。
- 计算 `tonalness`（快速 EMA）作为 gate：综合谐波谱平坦度、chroma/bass 峰值证据、谐波能量占比。
- 当 `tonal_ema < tonal_min` 时输出 `N/A(无调性)`（state=`atonal`），并降低 chroma EMA 更新权重（避免无调性段稀释调性统计）。

## 处理链路总览

整体仍采用“流式 + 滑动窗口”的结构，但与 BPM 支路尽量解耦，避免互相影响：

1. 采集系统回环音频 → 单声道化、浮点化。
2. 预处理：静音门限、频段限制、（可选）轻量谱白化。
3. STFT（短时傅里叶变换）→ 幅度谱。
4. （可选但推荐）HPSS：将谱图拆为 **Harmonic**（谐波/旋律）与 **Percussive**（打击/噪声）两支路。
5. 每帧用 Harmonic 支路生成 12 维 **Chroma/HPCP**（音高类别能量分布）。
5. 在时间上对 chroma 做滑动累积/指数平滑，形成“当前 chroma 概况”。
6. 与 24 个调性模板做相似度匹配 → 得到 Top-1/Top-2 Key 与分数。
7. 计算置信度，并在展示层做滞回与稳定化 → 实验阶段先打印控制台日志；后续可输出 `key_update` 事件供 UI 使用。

## 音频预处理

### 静音/弱信号 gating

- 复用现有 RMS/电平估计：若连续一段时间能量低于阈值，则：
  - 不更新 chroma 累积（或向零衰减），输出“不确定”；
  - 清理过期的历史窗口，避免“残留调性”。

### 频段限制（建议）

调性信息主要来自谐波音高而非超低频与超高频噪声，建议限制频段：

- 下限：`~60–80 Hz`（过滤次声与低频噪声）
- 上限：`~4–5 kHz`（过滤齿音与高频噪声）

### （可选）谱白化与动态范围压缩

为了避免少数频段/乐器“压制”整体 chroma，可采用轻量处理（保持 KISS，先做 1 项即可）：

- 幅度压缩：`mag := mag^γ`，`γ∈[0.3, 0.7]`
- 频域白化：对每个频点维护一个缓慢 EMA，`mag := mag / (ema_mag + eps)`

## HPSS：区分“有旋律/无旋律”的最低成本方案

很多片段（纯鼓点、噪声、FX、扫频、talking、环境声）并不具备稳定的音高结构；对这类片段强行输出 Key 往往会“看起来有数值、但不可用”。HPSS（Harmonic-Percussive Source Separation）是一个非常实用的工程折中：

- **思路**：在 STFT 幅度谱图 `S(f, t)` 上做中值滤波，得到：
  - 谐波估计 `H`：对每个频点沿 **时间轴**做中值滤波（谐波在时间上更“水平/连续”）。
  - 打击估计 `P`：对每个时间帧沿 **频率轴**做中值滤波（打击在频率上更“竖直/宽带”）。
- **Soft Mask**：用软掩膜把原谱分到两支路（避免硬切割带来的伪影）：
  - `M_h = H^p / (H^p + P^p + eps)`（`p≈2` 常用）
  - `S_h = M_h * S` 作为谐波谱（用于 chroma / key）
  - `S_p = (1 - M_h) * S` 作为打击谱（用于判定“无调性段”）

工程落地要点（面向实时）：

- **流式实现**：时间中值滤波需要保留最近 `K` 帧谱（引入约 `K * hop` 的小延迟），但 `K` 取 7–15 一般就足够。
- **调性判断（N/A）**：可结合
  - 谐波能量占比 `harmonic_ratio = sum(S_h)/sum(S)`
  - 谐波谱平坦度（更“噪声”则平坦度更高）
  - chroma 集中度（接近均匀则不可判调）
  在短窗口内快速 EMA 后，低于阈值即输出 `N/A(无调性)`。

## 特征构建：Chroma / HPCP（12 维）

### STFT（代表参数）

- 采样率：直接使用系统采样率，或（可选）重采样到 `22050 Hz` 降低计算量。
- 窗长 `N`：`4096`（较低延迟、CPU 友好）或 `8192`（更好的低频分辨率）。
- Hop：`N/4` 或 `N/2`（平衡实时性与平滑度）。
- 窗函数：Hann。
- 使用功率谱或幅度谱均可（需与模板匹配方式统一）。

### 频率 → pitch class 的映射

对每个频点中心频率 `f`（Hz）计算其对应的半音与音高类别：

- MIDI：`m = 69 + 12 * log2(f / 440)`
- pitch class：`pc = round(m) mod 12`（`0=C, 1=C#, ... 11=B`）

然后将该频点能量累加到 `chroma[pc]`。为提升鲁棒性，可用“邻域扩散”代替硬四舍五入：

- 对 `pc` 两侧做三角/高斯权重分配（带宽约 `±0.5` 半音），减少跑音与谱泄漏影响。

### 跨八度折叠与归一化

- Chroma 的核心是“跨八度合并”，因此天然将多个八度的同名音合并。
- 对每帧 chroma 做：
  - `log1p` 或幂压缩（抑制强音高主导）
  - `L1` 或 `L2` 归一化（使不同响度可比）

## 时间聚合：15 秒内可稳定的滚动估计

调性不是瞬时量，需要时间上下文。建议以**最近 T 秒**为统计窗口：

- 默认窗口 `T = 12s`（可调 `8–15s`）
- 更新周期 `Δ = 0.5–1.0s`（UI 刷新节流）

聚合方式（择一，优先 KISS）：

- **滑动累积**：保存每帧 chroma，维护最近 `T` 的求和（或均值）。
- **指数滑动（EMA）**：`C := (1-α) * C + α * chroma`，并在静音时加速衰减。

注意：窗口越长越稳，但切歌/转调跟随越慢；`T=12s` 通常能在“≤15 秒稳定”与“可跟随”之间取得平衡。

## 调性推断：模板匹配（24 类）

### 模板选择

调性估计常用 **Krumhansl–Schmuckler** 或 **Temperley** 等 12 维 profile（分别用于大调/小调）。实现上建议：

- 预置一组 `major_profile[12]` 与 `minor_profile[12]`（固定常量）。
- 对每个 tonic（C..B）做循环移位，形成 24 个模板。

**面向电子音乐的建议**：EDM 的和声材料往往更“功能化”（主三和弦/属音更突出），且自然小调（b6/b7）出现频率更高；经典 K-S（偏古典/流行统计）在一些曲目上容易被 IV/V/VI 等和弦重心“带跑”。因此实验阶段建议以 **EDM 启发式 profile** 作为默认模板，并保留经典 profile 作为对照。

经典 K-S profile（以 `C..B` 为 0..11 的顺序，便于回归对照）：

- Major：`[6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88]`
- Minor：`[6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17]`

EDM 启发式 profile（示例思路）：

- Major：强化 `1/3/5`（主三和弦）与 `5`（属音），弱化半音噪声底
- Minor：在 `1/b3/5` 基础上，强化 `b6/b7`（自然小调）并对 `7`（和声/旋律小调）给小权重

说明：模板与输入 chroma 都建议在匹配前做同一种归一化（例如 `L2`）。

### 相似度计算

将“聚合 chroma 向量”与每个模板做相似度：

- 余弦相似度（推荐，尺度无关）
- 或皮尔逊相关（对“形状”更敏感）

取最高分为 Top-1 Key，次高为 Top-2 Key。

### 置信度（建议可解释、可调）

置信度建议同时考虑“绝对匹配度”与“Top-1/Top-2 间隔”：

- `gap = score1 - score2`
- `confidence = clamp01(a * score1 + b * gap)`（或对 gap 做 sigmoid）

典型经验：

- `gap` 更能反映“是否明确”，能有效抑制相对大/小调、近关系调（五度圈相邻）造成的误切。
- 当 `confidence < τ_low`：输出“不确定”或保留上一次稳定值。

## 展示层稳定化（避免抖动）

与 BPM 展示类似，Key 也建议做“稳定展示，不追求秒级频繁切换”：

- **Warm-up**：启动后至少积累 `4–6s` 的有效 chroma 才允许首次输出 Key。
- **滞回切换**：新 Key 需在连续 `K` 次更新中胜出，或 `score_new` 超过 `score_old + δ` 才切换。
- **低置信度策略**：
  - 显示“不确定”
  - 或显示 `Top-2`（例如 `C#m / E`，用于提示相对大/小调歧义）
- **静音恢复**：长时间静音后恢复有声，重置聚合状态或进入短暂快速期以加速收敛。

## 与现有工程的落地建议（最小侵入）

### 后端模块划分（建议）

- 新增 `KeyEngine`（或 `key` 模块），只负责：
  - STFT → chroma
  - 时间聚合
  - 模板匹配与置信度
- 采集主循环（`capture.rs`）只负责把音频帧送入 KeyEngine，并按节流周期 emit：
  - 避免把 FFT/STFT 直接塞进主循环的热点路径（可用专用线程 + ring buffer）。
- 采样率变化/用户重置时：清空 KeyEngine 的历史缓冲与聚合状态，必要时重建 STFT 计划，避免旧状态污染新歌或新设备。

### 数据结构与事件（建议）

建议新增一个展示结构体（类比 `DisplayBpm`）并通过事件推送：

- `key_update`：`{ key: string | null, confidence: f32, state: "analyzing"|"tracking"|"uncertain", window_sec: f32, level: f32, top2?: [...] }`

说明：

- 当前实验阶段暂未接入 `key_update` 事件，先以控制台 `[调性] ...` 日志为准，方便快速调参。
- `key=null` 表示“不确定/无效”。
- `window_sec` 便于 UI 显示“已分析时长”或用于调参。
- `top2` 可选，仅在调试模式或低置信度时发送，避免增加前端复杂度。

### UI 展示建议

- 主显示：`Key` + 置信度（条/点亮程度）。
- 低置信度：显示 `…` 或 `不确定`；可在 hover/调试面板显示 Top-2。
- 切歌/能量突变：短暂显示 `analyzing` 状态，避免误导。

## 关键参数（代表值，后续需实测调参）

- **STFT**：`N=4096`，`hop=2048`，Hann
- **频段**：`80–5000 Hz`
- **Bass 混合**：`bass_max_hz≈250`，`bass_mix≈0.3`（增强主音线索，减少“被五度/七度带跑”）
- **Bass 主音提示**：`bass_tonic_bonus≈0.12`（当 bass chroma 主峰明显时，对同主音候选做小幅加分，用于稳定 tonic）
- **时间窗口**：`T=12s`，更新 `Δ=0.5s`
- **HPSS**：`time_frames≈9`，`freq_bins≈17`，`mask_power≈2`
- **置信度阈值**：`τ_low≈0.35`（不确定），`τ_high≈0.55`（稳定）
- **无旋律/N/A 门限**：当前默认 `tonal_min≈0.50`；tonalness 由“谱平坦度 + pitch 峰值/次峰值 + 谐波占比”组合后再判定（见 `src-tauri/src/key.rs`）
- **滞回**：`K=3` 次连续胜出，或 `δ≈0.05` 的分数优势

## 实验记录（与 Rekordbox 对照，供后续迭代）

对话中的关键观测（均为播放端未移调的原版音频）：

- 目标场景以电子音乐为主，但在“无旋律/鼓点段”此前会输出看似稳定的 Key（误导）；引入 HPSS + tonal gate 后，确实能在这些段落更倾向输出 `N/A(无调性)`，降低噪声 Key。
- 仍存在与 Rekordbox（整首分析）不一致的情况：例如 Rekordbox 标注 `2A` 的曲目在部分无旋律段会跑出大量 `6B`；Rekordbox 标注 `8A` 的曲目则出现 `7B/8B/9B` 等邻近 Key 的漂移。

可能原因（需要进一步用样本与参数验证，而非拍脑袋）：

- **相对大/小调歧义**：`8A` 与 `8B` 属于同一组（相对关系调），若旋律/和声材料更偏“和弦大三和弦色彩”，容易被判成大调。
- **低频主音线索缺失**：当前 `min_hz=80Hz` 可能丢失部分 sub-bass 基频；需要在 `60Hz/40Hz` 等配置下对比。
- **模板与权重**：电子音乐的和声材料与经典 KS profile 分布不同；当前默认 `EdmTriadV1` 仍需迭代（以及 `bass_mix/bass_tonic_bonus`）。
- **gate 仍不够严**：在“半有旋律”的段落（例如 pad/噪声+弱旋律）可能仍会被判为有调性，进而输出不稳定 Key。

后续建议（按优先级）：

- P0：用合成样本 `python "scripts/generate_tonal_house_sample.py"` 建立“应输出 3B”的最小回归闭环，先把 `N/A` 与 Key 稳定性调到可控。
- P1：用 2–3 首调性极明确的 House/EDM 做交叉测试（同一段落重复多次），记录 Top-1/Top-2/置信度随时间变化，用于定位是“mode 歧义”还是“tonic 偏移”。
- P1：调参顺序建议：先调 `tonal_min` 与 tonalness 证据阈值（减少无旋律误判）→ 再调 `min_hz/bass_mix/bass_tonic_bonus`（改善主音）→ 最后迭代 `EdmTriadV1` 模板权重（改善 mode/关系调区分）。
- P2：若仍难稳定，可考虑 beat-synchronous chroma（利用已存在的 BPM 信息对齐）或更高分辨率的 CQT/VQT（成本更高，后置）。

## 注意事项与后续方向

- **相对大/小调歧义**（如 `C#m` vs `E`）很常见：建议用 `gap` 与“Top-2 展示”策略处理，而不是硬判。
- **鼓点/噪声主导**时 chroma 会失真：优先依赖静音门限 + 频段限制 + 幅度压缩。
- **更高精度方向**（按需逐步增加复杂度，避免过度设计）：
  - 常 Q 变换（CQT/VQT）替代 STFT 映射，提高音高对齐度
  - 更高质量的 HPSS/谱峰追踪（或基于谐波峰的 HPCP），进一步削弱打击乐与噪声
  - Beat-synchronous chroma（利用 BPM/拍点对齐）提升稳定性
  - 转调检测与分段（输出“当前段主调”）
